---
title: "E. coli in silico mixture results"
output:
  workflowr::wflow_html:
      code_folding: hide
---

In this experiment, the duplex reads from NanoSeq MB2 rep 1 from E coli K12 was mixed (in silico) at 10x depth with the duplex reads from NanoSeq MB2 (MGI) from E coli BL21 at 90x depth creating a 10\% mixed genome. There are >33k SNP and INDEL differences between the E coli species, so we would expect to find approximately this many SNPs at the mixture frequency.

```{r setup, include=FALSE}
DOCNAME = "Ecoli in silico mixture results"
knitr::opts_chunk$set(autodep        = TRUE,
                      cache          = FALSE,
                      cache.path     = paste0("cache/", DOCNAME, "/"),
                      cache.comments = FALSE,
                      cache.lazy     = FALSE,
                      echo           = TRUE,
                      error          = FALSE,
                      fig.align      = "center",
                      fig.width      = 9,
                      fig.height     = 5,
                      dev            = c("png"),
                      message        = FALSE,
                      warning        = FALSE)
```


```{r libraries, cache=FALSE, message=FALSE}
library(ggplot2)
library(data.table)
library(dplyr)
library(here)
library(tibble)
library(stringr)
library(Rsamtools)
library(GenomicRanges)
library(seqinr)
library(readxl)
library(patchwork)
library(RColorBrewer)
library(UpSetR)
library(vcfR)
```


```{r source}
source(here('code/load_data.R'))

calculate_vafs <- function(var_df, freq_filter = 0.3) {
    tmp <- var_df$Sample1 %>% str_split(':') %>% lapply(., function(x){as.numeric(x[5:6])}) 
    var_df$RD <- lapply(tmp, head, 1) %>% unlist()
    var_df$AD <- lapply(tmp, tail, 1) %>% unlist()
    
    var_df$VAF <- var_df$AD / (var_df$AD + var_df$RD)
    var_df <- var_df[var_df$VAF < freq_filter,]
    
    return(var_df)
}
```


```{r paths}
variant_dir <- here('data/mixtures')
```


```{r load_data}
var_df <- load_variants(variant_dir, c('NanoMB2-0.01', 'NanoMB2-0.05', 'ManoMB2-0.10')) %>% calculate_vafs()
```


## VAF mixture distributions

NanoSeq MB2 mixes:

- 1:99x K12:BL21 (0.01 mix)
- 5:95x K12:BL21 (0.05 mix)
- 10:90x K12:BL21 (0.10 mix)


```{r plot_vafs}
data.table(var_df)[, list(VAF_mean = mean(VAF), nvars = length(POS)), by=sample] %>% print()

ggplot(var_df, aes(VAF)) +
    geom_histogram(bins = 50) +
    theme_minimal() +
    facet_grid(~sample) +
    scale_x_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1))
```

