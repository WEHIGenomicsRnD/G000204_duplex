---
title: "Rare mutation detection model"
output:
  workflowr::wflow_html:
      code_folding: hide
---

```{r knitr, include = FALSE}
DOCNAME = "Simulation_Benchmarking"
knitr::opts_chunk$set(autodep        = TRUE,
                      cache          = FALSE,
                      cache.path     = paste0("cache/", DOCNAME, "/"),
                      cache.comments = FALSE,
                      echo           = TRUE,
                      error          = FALSE,
                      fig.align      = "center",
                      fig.width      = 9,
                      fig.height     = 5,
                      dev            = c("png"),
                      message        = FALSE,
                      warning        = FALSE)
```

```{r libraries, cache = FALSE}
library(ggplot2)
```

# Model

Q: what is the lowest % VAF of mutation we can reliably detect (at >95% confidence) using Nanoseq on bulk WES?

## Assumptions

* We consider a human diploid genome without SCNAs
* The mutation is heterozygous
* We sequence 15,000 cells
* Our duplex rate is optimal ~81%
* Our ligation efficiency is 20%
* We assume a duplex mutation call equals a real mutation (theoretical error rate of duplex sequencing is <10^-9)

## Probability of sequencing a mutant cell

Let $f$ be the probability of sequencing a mutation from a single fragment, on both strands.

$f = (v / p) \times d \times l$

Where:

* $v$ = target VAF
* $p$ = ploidy (2)
* $d$ = duplex efficiency (0.81)
* $l$ = ligation efficiency (0.2)

We assume the probability of sequencing a mutant fragment is binomially distributed. We want to know the probability of selecting at least one mutant fragment:

$P(Bin(f, n)) > 0)$ = 0.95

This is equivalent to:

$P(Bin(f, n)) = 0)$ = 0.05

Where $n$ is the number of sequenced cells (15,000). We note that the number of mutant cells will, on average, will be $2nv$. 

Since we don't know $v$, we'll define a vector of possible VAFs incremented by $0.001$, $V = \{0.001, 0.002..0.01\}$. Using these values, we can plot the probability of _not_ sequencing the mutant fragment, at each VAF (line is at 0.05). 

```{r vaf_plot}
d = 0.81
l = 0.2
v = seq(0.001, 0.01, 0.0001)
f = (v / 2) * d * l
n = 15000

vafs <- data.frame(vaf=v,
                   p=dbinom(0, n, f),
                   mutant_cells=(n * v * 2))

ggplot(vafs, aes(vaf, p)) +
    geom_point() +
    theme_bw() +
    geom_hline(yintercept=0.05, alpha=0.4)
```

We can also plot this as mutant cells instead of VAF:

```{r mutant_cells_plot}
ggplot(vafs, aes(mutant_cells, p)) +
    geom_point() +
    theme_bw() +
    geom_hline(yintercept=0.05, alpha=0.4)
```

For this range of VAFs, 0.0025 (0.25%) is the smallest VAF for which the probability of missing the mutant is approximately 0.05. A VAF of 0.0025 translates to 75 mutant cells on average in our input of 15,000.

```{r VAF_at_0.05}
deviation <- abs(0.05 - vafs$p)
print(vafs[which(deviation == min(deviation)),])
```

## Varying the number of input cells

If we change the number of input cells, how does this change the probability calculation? Let's assume the target VAF is 0.0025 from our previous calculation (line is at 0.05).

```{r varying_input_cells}
v = 0.0025
n = seq(1000, 20000, 1000)
f = (v / 2) * d * l

cells <- data.frame(vaf=v,
                    p=dbinom(0, n, f),
                    total_cells=n,
                    mutant_cells=(n * v * 2))

ggplot(cells, aes(total_cells, p)) +
    geom_point() +
    theme_bw() +
    geom_hline(yintercept=0.05, alpha=0.4)
```

We can then expand this to different target VAFs.

Let's define our VAFs as $V = \{0.01, 0.02..0.2\}$ and put these on a single plot (line at p = 0.05).

```{r cells_vs_vaf_plot, fig.height=6.5, fig.width=9}
cells_vs_vaf = NULL
n = seq(100, 5000, 100)
V = seq(0.01, 0.20, 0.01)
for (v in V) {
    f = (v / 2) * d * l
    toadd <- data.frame(
        vaf=as.factor(v),
        p=dbinom(0, n, f),
        total_cells=n
    )
    cells_vs_vaf <- rbind(cells_vs_vaf, toadd)
}

ggplot(cells_vs_vaf, aes(total_cells, p, colour=vaf)) +
    geom_line() +
    theme_bw() +
    theme(legend.position = 'bottom') +
    geom_hline(yintercept=0.05, alpha=0.4)
```

